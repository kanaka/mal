# Types:
# Â¯1 error
# 0 symbol
# 1 int
# 2 string
# 3 list
# 4 vector
# 5 hashmap
# 6 keyword
# 7 boolean
# 8 nil

Reader â† {ğ•Š tokens:
  r â† {
    ts â† tokens
    Peek â‡ {ğ•Š â‹„ 0=â‰ ts ? @; âŠ‘ts}
    Next â‡ {ğ•Š
      t â† r.Peek@
      ts â†© 1â†“ts
      t
    }
  }
}

T â† {ğ•Š s:
  {
    0=â‰ s ? âŸ¨âŸ© ;
    @=âŠ‘s ? â€¢Exit 0 ;
    "~@"â‰¡2â†‘s ? (<"~@") âˆ¾ T 2â†“s ;
    âŠ‘(âŠ‘s)âˆŠ" ,"âˆ¾@+10 ? T 1â†“s ;
    âŠ‘(âŠ‘s)âˆŠ"[]{}()'`~" ? (<â‰âŠ‘s) âˆ¾ T 1â†“s ;
    ';'=âŠ‘s ?
      oâ†âŸ¨âŸ©
      {ğ•Š
        o âˆ¾â†© âŠ‘s
        s â†© 1â†“s
        {0=â‰ s ? 0 ; (âŠ‘s) â‰  @+10}
      } â€¢_while_âŠ¢1
      (<o) âˆ¾ T s ;
    """"â‰¡s ? â€¢Out "unbalanced quotes: """ â‹„ @;
    '"'=âŠ‘s ?
      oâ€¿pâ€¿r â† """"â€¿1â€¿1
      {ğ•Š
        s â†© 1â†“s
        c â† âŠ‘s
        o âˆ¾â†© c
        q â† pâˆ§c='"'
        {p ? pâ†©câ‰ '\' ; pâ†©1}
        {q?@;r â†© 1<â‰ s}
        râˆ§Â¬q
      } â€¢_while_âŠ¢1
      {r?@;â€¢Out "unbalanced quotes: "âˆ¾o}
      (<o) âˆ¾ T 1â†“s ;
    oâ†âŸ¨âŸ©
    {ğ•Š
      o âˆ¾â†© âŠ‘s
      s â†© 1â†“s
      {0=â‰ s ? 0 ; Â¬âŠ‘(âŠ‘s)âˆŠ"[]{}()'""`~,; "âˆ¾@+10}
    } â€¢_while_âŠ¢1
    (<o) âˆ¾ T s
  }
}

Int â† {10âŠ¸Ã—âŠ¸+ËœÂ´'0'-ËœâŒ½ğ•©}
nums â† "0123456789"
Atom â† {
  ğ•Š "true": 7â€¿1 ;
  ğ•Š "false": 7â€¿0 ;
  ğ•Š "nil": 8â€¿âŸ¨âŸ© ;
  ğ•Š a: {'"': 2âˆ¾<Â¯1â†“1â†“a ;
   ':': 6â€¿a ;
   âŠ‘ğ•©âˆŠnums ? 1âˆ¾Int a ;
   (ğ•©='-')âˆ§1<â‰ a ? 1âˆ¾-Int 1â†“a ;
   0â€¿a }âŠ‘a
}

ReadList â† {ğ•Š râ€¿tâ€¿e:
  lâ†âŸ¨âŸ©
  {ğ•Š
    {@: t â†© Â¯1 â‹„ l â†© "unbalanced parens" â‹„ 0;
     ğ•©â‰¡e ? r.Next@ â‹„ 0;
     l âˆ¾â†© <ReadForm r â‹„ 1
    }r.Peek@
  }â€¢_while_âŠ¢1
  tâ€¿l
}

ReadForm â† {ğ•Š r:
  {"(": ReadList râ€¿3â€¿")" ;
   "[": ReadList râ€¿4â€¿"]" ;
   "{": ReadList râ€¿5â€¿"}" ;
   Atom ğ•©
  }r.Next@
}

{
  Tokenize â‡ T
  ReadStr â‡ ReadFormâˆ˜Readerâˆ˜Tokenize
}
