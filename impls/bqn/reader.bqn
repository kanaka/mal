âŸ¨nilâŸ© â† â€¢Import "globals.bqn"
# Types:
# Â¯1 error
# 0 symbol
# 1 int
# 2 string
# 3 list
# 4 vector
# 5 hashmap
# 6 keyword
# 7 boolean
# 8 nil
# 9 function
# 10 fn*
# 11 atom
# 12 macro

Reader â† {ğ•Š tokens:
  r â† {
    ts â† tokens
    Peek â‡ {ğ•Š â‹„ 0=â‰ ts ? @; âŠ‘ts}
    Next â‡ {ğ•Š
      t â† r.Peek@
      ts â†© 1â†“ts
      t
    }
  }
}

T â† {ğ•Š s:
  vâ†âŸ¨âŸ©
  {ğ•Š
    @=âŠ‘s ? â€¢Exit 0 ;
    '@'=âŠ‘s ? vâˆ¾â†©<"@" â‹„ sâ†©1â†“s ;
    "~@"â‰¡2â†‘s ? vâˆ¾â†©<"~@" â‹„ sâ†©2â†“s ;
    âŠ‘(âŠ‘s)âˆŠ" ,"âˆ¾@+10 ? sâ†©1â†“s ;
    âŠ‘(âŠ‘s)âˆŠ"[]{}()'`~" ? vâˆ¾â†©<â‰âŠ‘s â‹„ sâ†©1â†“s ;
    ';'=âŠ‘s ?
      oâ†âŸ¨âŸ©
      {ğ•Š
        o âˆ¾â†© âŠ‘s
        s â†© 1â†“s
        {0=â‰ s ? 0 ; (âŠ‘s) â‰  @+10}
      } â€¢_while_âŠ¢1
      vâˆ¾â†©<o ;
    """"â‰¡s ? â€¢Out "unbalanced quotes: """ â‹„ sâ†©âŸ¨âŸ©;
    '"'=âŠ‘s ?
      oâ€¿pâ€¿r â† """"â€¿1â€¿1
      {ğ•Š
        s â†© 1â†“s
        c â† âŠ‘s
        o âˆ¾â†© c
        q â† pâˆ§c='"'
        {p ? pâ†©câ‰ '\' ; pâ†©1}
        {q?@;r â†© 1<â‰ s}
        râˆ§Â¬q
      } â€¢_while_âŠ¢1
      {r?@;â€¢Out "unbalanced quotes: "âˆ¾o}
      vâˆ¾â†©<o â‹„ sâ†©1â†“s;
    oâ†âŸ¨âŸ©
    {ğ•Š
      o âˆ¾â†© âŠ‘s
      s â†© 1â†“s
      {0=â‰ s ? 0 ; Â¬âŠ‘(âŠ‘s)âˆŠ"[]{}()'""`~,; "âˆ¾@+10}
    } â€¢_while_âŠ¢1
    vâˆ¾â†©<o
  }â€¢_while_{ğ•Š â‹„ 0â‰ â‰ s}@
  v
}

# Thanks to Marshall for writing this version of readString and
# suhr for suggesting the `out` value of Ctrl-* characters! (My
# version was verbose functional code while this is array style.)
readString â† {
  in  â† "abefnrtv"
  out â† "GH[LJMIK"-64
  diffâ† (out-in)âˆ¾0
  {
    m â† Â» bs â† <`ğ•©='\'
    (Â¬bs) / (diffâŠËœinâŠ¸âŠ)âŠ¸+âŒ¾(mâŠ¸/) ğ•©
  }
}

Int â† {10âŠ¸Ã—âŠ¸+ËœÂ´'0'-ËœâŒ½ğ•©}
nums â† "0123456789"
Atom â† {
  ğ•Š "true": 7â€¿1 ;
  ğ•Š "false": 7â€¿0 ;
  ğ•Š "nil": nil ;
  ğ•Š a: {'"': 2âˆ¾<ReadString 1â†“Â¯1â†“a ;
   ':': 6â€¿a ;
   ';': @ ;
   âŠ‘ğ•©âˆŠnums ? 1âˆ¾Int a ;
   (âˆ§Â´(1â†“a)âˆŠnums)âˆ§(ğ•©='-')âˆ§1<â‰ a ? 1âˆ¾-Int 1â†“a ;
   0â€¿a }âŠ‘a
}

ReadList â† {ğ•Š râ€¿tâ€¿e:
  lâ†âŸ¨âŸ©
  {ğ•Š
    {@: t â†© Â¯1 â‹„ l â†© "unbalanced parens" â‹„ 0;
     ğ•©â‰¡e ? r.Next@ â‹„ 0;
     v â† ReadForm r
     {vâ‰¡@ ? @; lâˆ¾â†©<v}
     1
    }r.Peek@
  }â€¢_while_âŠ¢1
  tâ€¿l
}

ReadForm â† {ğ•Š r:
  {"(": ReadList râ€¿3â€¿")" ;
   "[": ReadList râ€¿4â€¿"]" ;
   "{": ReadList râ€¿5â€¿"}" ;
   "@": 3â€¿âŸ¨0â€¿"deref", ReadForm râŸ©;
   "'": 3â€¿âŸ¨0â€¿"quote", ReadForm râŸ©;
   "`": 3â€¿âŸ¨0â€¿"quasiquote", ReadForm râŸ©;
   "~": 3â€¿âŸ¨0â€¿"unquote", ReadForm râŸ©;
   "~@": 3â€¿âŸ¨0â€¿"splice-unquote", ReadForm râŸ©;
   Atom ğ•©
  }r.Next@
}

{
  Tokenize â‡ T
  ReadStr â‡ {
    v â† ReadForm Reader Tokenize ğ•©
    vâ‰¢@ ? v ; nil}
}
