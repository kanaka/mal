âŸ¨EnvâŸ© â† â€¢Import "env.bqn"
âŸ¨ReadStr,nilâŸ© â† â€¢Import "reader.bqn"
âŸ¨PrStrâŸ© â† â€¢Import "printer.bqn"
âŸ¨coreâŸ© â† â€¢Import "core.bqn"

EvalAst â† {env ğ•Š tâ€¿v:
  {0: env.Get v ;
   3: envâŠ¸EVALÂ¨v ;
   tâ€¿v
  }t
}

READ â† ReadStr
PRINT â† PrStr
EVAL â† {
  # builtin symbols
  env ğ•Š 3â€¿âŸ¨0â€¿"def!",0â€¿k,xâŸ©:
    v â† env EVAL x
    {Â¯1:@;env.Set (<k)âˆ¾<v}âŠ‘v
    v ;
  outer ğ•Š 3â€¿âŸ¨0â€¿"let*",tâ€¿binds,expâŸ©:
    inner â† Env outer
    {ğ•Š
      {âŸ¨0â€¿kw,xâŸ©: inner.Set (<kw)âˆ¾<inner EVAL x}2â†‘binds
      binds 2âŠ¸â†“â†©
    }â€¢_while_{ğ•Š â‹„ 0<â‰ binds}@
    inner EVAL exp ;
  env ğ•Š 3â€¿âŸ¨0â€¿"if",c,t,fâŸ©:
    env EVAL {8â€¿x:f; 7â€¿0:f; t} env EVAL c ;
  env ğ•Š 3â€¿âŸ¨0â€¿"if",c,tâŸ©:
    env EVAL {8â€¿x:nil; 7â€¿0:nil; t} env EVAL c ;
  outer ğ•Š 3â€¿âŸ¨0â€¿"fn*",3â€¿args,expâŸ©:
    9â€¿{ğ•Š xs:
      as â† args
      inner â† Env outer
      {ğ•Š
        {0â€¿kw: inner.Set (<kw)âˆ¾<inner EVAL âŠ‘xs}âŠ‘as
        as 1âŠ¸â†“â†©
        xs 1âŠ¸â†“â†©
      }â€¢_while_{ğ•Š â‹„ 0<â‰ as}@
      inner EVAL exp} ;

  # data
  env ğ•Š 3â€¿âŸ¨âŸ©: 3â€¿âŸ¨âŸ© ;
  env ğ•Š 3â€¿xs:
    ys â† env EvalAst 3â€¿xs
    f â† âŠ‘ys
    {9â€¿f: F 1â†“ys ;
     â€¢Show "ERROR: function "â€¿f}f;
  env ğ•Š 4â€¿xs: 4âˆ¾<envâŠ¸EVALÂ¨xs ;
  env ğ•Š 5â€¿xs: 5âˆ¾<envâŠ¸EVALÂ¨xs ;
  env ğ•Š x: env EvalAst x
}
Rep â† PRINTâˆ˜{core EVAL ğ•©}âˆ˜READ

{
  â€¢Out "user> "
  line â† â€¢GetLine 0
  â€¢Out Rep line
  ğ•Šğ•©
}@
