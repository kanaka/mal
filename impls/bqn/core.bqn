âŸ¨Atom,nilâŸ© â† â€¢Import "globals.bqn"
âŸ¨EnvâŸ© â† â€¢Import "env.bqn"
âŸ¨PrStr,PrStrRâŸ© â† â€¢Import "printer.bqn"
âŸ¨ReadStrâŸ© â† â€¢Import "reader.bqn"

Q â† {âˆ¾Â´'"'âˆ¾ğ•©âˆ¾'"'}
J â† {0=â‰ ğ•© ? "" ;
     1=â‰ ğ•© ? âŠ‘ğ•© ;
     âˆ¾Â´(âŠ‘ğ•©)âˆ¾ğ•¨âˆ¾ğ•¨J 1â†“ğ•©}

ns â† âŸ¨
  "+"â€¿{1âˆ¾+Â´1âŠË˜>ğ•©}
  "-"â€¿{1âˆ¾-Â´1âŠË˜>ğ•©}
  "*"â€¿{1âˆ¾Ã—Â´1âŠË˜>ğ•©}
  "/"â€¿{1âˆ¾âŒŠâˆ˜Ã·Â´1âŠË˜>ğ•©}

  "="â€¿{7âˆ¾âˆ§Â´â‰¡Â´Ë˜2â†•ğ•©}
  "<"â€¿{7âˆ¾âˆ§Â´<Â´Ë˜2â†•1âŠ¸âŠ‘Â¨ğ•©}
  "<="â€¿{7âˆ¾âˆ§Â´â‰¤Â´Ë˜2â†•1âŠ¸âŠ‘Â¨ğ•©}
  ">"â€¿{7âˆ¾âˆ§Â´>Â´Ë˜2â†•1âŠ¸âŠ‘Â¨ğ•©}
  ">="â€¿{7âˆ¾âˆ§Â´â‰¥Â´Ë˜2â†•1âŠ¸âŠ‘Â¨ğ•©}

  "list"â€¿{3â€¿ğ•©}
  "list?"â€¿{7âˆ¾3=âŠ‘âŠ‘ğ•©}
  "empty?"â€¿{7âˆ¾0=â‰ 1âŠ‘âŠ‘ğ•©}
  "count"â€¿{1âˆ¾â‰ 1âŠ‘âŠ‘ğ•©}

  "bqn-show"â€¿{â€¢Show âŠ‘ ğ•©}
  "pr-str"â€¿{2âˆ¾<" "J PrStrRÂ¨ğ•©}
  "str"â€¿{2âˆ¾<""J PrStrÂ¨ğ•©}
  "prn"â€¿{â€¢Out " "J PrStrRÂ¨ğ•© â‹„ nil}
  "println"â€¿{â€¢Out " "J PrStrÂ¨ğ•© â‹„ nil}

  "read-string"â€¿{ReadStr 1âŠ‘âŠ‘ğ•©}
  "slurp"â€¿{2âˆ¾<â€¢FChars 1âŠ‘âŠ‘ğ•©}

  "atom"â€¿{11âˆ¾Atom âŠ‘ğ•©}
  "atom?"â€¿{7âˆ¾11=âŠ‘âŠ‘ğ•©}
  "deref"â€¿{ğ•Š âŸ¨11â€¿aâŸ©: a.Deref@; Â¯1â€¿"deref: not an atom"}
  "reset!"â€¿{
    ğ•Š âŸ¨11â€¿a,vâŸ©: a.Reset v;
    Â¯1â€¿"reset!: not an atom"}
  "swap!"â€¿{
    âŸ¨tâ€¿a,fnâŸ© â† 2â†‘ğ•©
    args â† (<a.Deref@) âˆ¾ 2â†“ğ•©
    f â† {9â€¿f: f; 10â€¿xâ€¿yâ€¿zâ€¿f: f}fn
    a.Reset F args}

  "cons"â€¿{ğ•Š xâ€¿âŸ¨t,xsâŸ©: 3âˆ¾<(<x)âˆ¾xs ; Â¯1â€¿"cons"}
  "concat"â€¿{ğ•Š âŸ¨âŸ©:3â€¿âŸ¨âŸ©; 3âˆ¾<âˆ¾Â´1âŠ¸âŠ‘Â¨ğ•©}

  "nth"â€¿{ğ•Š âŸ¨tâ€¿xs,1â€¿nâŸ©: {n<â‰ xs ? nâŠ‘xs ; Â¯1â€¿"out of bounds"}}
  "first"â€¿{S âŸ¨tâ€¿xsâŸ©: {0<â‰ xs ? âŠ‘xs ; nil}; nil}
  "rest"â€¿{ğ•Š âŸ¨tâ€¿âŸ¨âŸ©âŸ©: 3â€¿âŸ¨âŸ©; ğ•Š âŸ¨tâ€¿xsâŸ©: 3âˆ¾<1â†“xs; 3â€¿âŸ¨âŸ©}
âŸ©

core â‡ Env@
{ğ•Š kwâ€¿f: core.Set kwâ€¿(9â€¿f)}Â¨ns
