["do",

["load-file", ["`", "miniMAL-core.json"]],
["load-file", ["`", "types.json"]],
["load-file", ["`", "reader.json"]],
["load-file", ["`", "printer.json"]],
["load-file", ["`", "env.json"]],
["load-file", ["`", "core.json"]],

["def", "READ", ["fn", ["strng"], ["read-str", "strng"]]],

["def", "eval-ast", ["fn", ["ast", "env"],
  ["if", ["symbol?", "ast"],
    ["env-get", "env", "ast"],
  ["if", ["list?", "ast"],
    ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"],
  ["if", ["vector?", "ast"],
    ["vectorl", ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"]],
  ["if", ["map?", "ast"],
    ["let", ["new-hm", ["hash-map"]],
      ["do",
        ["map", ["fn", ["k"], ["set", "new-hm",
                                ["EVAL", "k", "env"],
                                ["EVAL", ["get", "ast", "k"], "env"]]],
                ["keys", "ast"]],
        "new-hm"]],
  "ast"]]]]]],

["def", "LET", ["fn", ["env", "args"],
  ["if", [">", ["count", "args"], 0],
    ["do",
      ["env-set", "env", ["nth", "args", 0],
                         ["EVAL", ["nth", "args", 1], "env"]],
      ["LET", "env", ["rest", ["rest", "args"]]]]]]],

["def", "EVAL", ["fn", ["ast", "env"],
  ["if", ["not", ["list?", "ast"]],
        ["eval-ast", "ast", "env"],
        ["let", ["a0", ["get", ["first", "ast"], ["`", "val"]]],
          ["if", ["=", ["`", "def!"], "a0"],
            ["env-set", "env", ["nth", "ast", 1],
                               ["EVAL", ["nth", "ast", 2], "env"]],
          ["if", ["=", ["`", "let*"], "a0"],
            ["let", ["let-env", ["env-new", "env"]],
              ["do",
                ["LET", "let-env", ["nth", "ast", 1]],
                ["EVAL", ["nth", "ast", 2], "let-env"]]],
          ["if", ["=", ["`", "do"], "a0"],
            ["let", ["el", ["eval-ast", ["rest", "ast"], "env"]],
              ["nth", "el", ["-", ["count", "el"], 1]]],
          ["if", ["=", ["`", "if"], "a0"],
            ["let", ["cond", ["EVAL", ["nth", "ast", 1], "env"]],
              ["if", ["or", ["=", "cond", null], ["=", "cond", false]],
                ["if", [">", ["count", "ast"], 3],
                  ["EVAL", ["nth", "ast", 3], "env"],
                  null],
                ["EVAL", ["nth", "ast", 2], "env"]]],
          ["if", ["=", ["`", "fn*"], "a0"],
              ["fn", ["&", "args"],
                ["let", ["e", ["env-new", "env", ["nth", "ast", 1], "args"]],
                  ["EVAL", ["nth", "ast", 2], "e"]]],
            ["let", ["el", ["eval-ast", "ast", "env"],
                     "f", ["first", "el"],
                     "args", ["rest", "el"]],
              ["apply", "f", "args"]]]]]]]]]]],

["def", "PRINT", ["fn", ["exp"],
  ["pr-str", "exp", true]]],


["def", "repl-env", ["env-new"]],

["def", "rep", ["fn", ["strng"],
  ["try",
    ["PRINT", ["EVAL", ["READ", "strng"], "repl-env"]],
    ["catch", "exc",
      ["str", ["`", "Error: "], [".", "exc", ["`", "toString"]]]]]]],

["`", "core.mal: defined using miniMAL"],
["map", ["fn", ["k"], ["env-set", "repl-env",
                                  ["symbol", "k"],
                                  ["get", "core-ns", "k"]]],
        ["keys", "core-ns"]],

["`", "core.mal: defined using mal itself"],
["rep", ["`", "(def! not (fn* (a) (if a false true)))"]],

["repl", ["`", "user> "], "rep"],

null

]
