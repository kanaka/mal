["do",

["load-file", ["`", "miniMAL-core.json"]],
["load-file", ["`", "types.json"]],
["load-file", ["`", "reader.json"]],
["load-file", ["`", "printer.json"]],
["load-file", ["`", "env.json"]],
["load-file", ["`", "core.json"]],

["def", "READ", ["fn", ["strng"], ["read-str", "strng"]]],

["def", "pair?", ["fn", ["x"],
  ["if", ["sequential?", "x"],
    ["if", [">", ["count", "x"], 0], true, false],
    false]]],

["def", "quasiquote", ["fn", ["ast"],
  ["if", ["not", ["pair?", "ast"]],
    ["list", ["symbol", ["`", "quote"]], "ast"],
  ["if", ["and", ["symbol?", ["nth", "ast", 0]],
                 ["=", ["`", "unquote"], ["get", ["nth", "ast", 0], ["`", "val"]]]],
    ["nth", "ast", 1],
  ["if", ["and", ["pair?", ["nth", "ast", 0]],
                 ["=", ["`", "splice-unquote"],
                       ["get", ["nth", ["nth", "ast", 0], 0], ["`", "val"]]]],
    ["list", ["symbol", ["`", "concat"]],
             ["nth", ["nth", "ast", 0], 1],
             ["quasiquote", ["rest", "ast"]]],
    ["list", ["symbol", ["`", "cons"]],
             ["quasiquote", ["nth", "ast", 0]],
             ["quasiquote", ["rest", "ast"]]]]]]]],

["def", "eval-ast", ["fn", ["ast", "env"],
  ["if", ["symbol?", "ast"],
    ["env-get", "env", "ast"],
  ["if", ["list?", "ast"],
    ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"],
  ["if", ["vector?", "ast"],
    ["vectorl", ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"]],
  ["if", ["map?", "ast"],
    ["let", ["new-hm", ["hash-map"]],
      ["do",
        ["map", ["fn", ["k"], ["set", "new-hm",
                                ["EVAL", "k", "env"],
                                ["EVAL", ["get", "ast", "k"], "env"]]],
                ["keys", "ast"]],
        "new-hm"]],
  "ast"]]]]]],

["def", "LET", ["fn", ["env", "args"],
  ["if", [">", ["count", "args"], 0],
    ["do",
      ["env-set", "env", ["nth", "args", 0],
                         ["EVAL", ["nth", "args", 1], "env"]],
      ["LET", "env", ["rest", ["rest", "args"]]]]]]],

["def", "EVAL", ["fn", ["ast", "env"],
  ["if", ["not", ["list?", "ast"]],
        ["eval-ast", "ast", "env"],
        ["let", ["a0", ["get", ["first", "ast"], ["`", "val"]]],
          ["if", ["=", ["`", "def!"], "a0"],
            ["env-set", "env", ["nth", "ast", 1],
                               ["EVAL", ["nth", "ast", 2], "env"]],
          ["if", ["=", ["`", "let*"], "a0"],
            ["let", ["let-env", ["env-new", "env"]],
              ["do",
                ["LET", "let-env", ["nth", "ast", 1]],
                ["EVAL", ["nth", "ast", 2], "let-env"]]],
          ["if", ["=", ["`", "quote"], "a0"],
            ["nth", "ast", 1],
          ["if", ["=", ["`", "quasiquote"], "a0"],
            ["EVAL", ["quasiquote", ["nth", "ast", 1]], "env"],
          ["if", ["=", ["`", "do"], "a0"],
            ["do",
              ["eval-ast", ["slice", "ast", 1, ["-", ["count", "ast"], 1]], "env"],
              ["EVAL", ["nth", "ast", ["-", ["count", "ast"], 1]], "env"]],
          ["if", ["=", ["`", "if"], "a0"],
            ["let", ["cond", ["EVAL", ["nth", "ast", 1], "env"]],
              ["if", ["or", ["=", "cond", null], ["=", "cond", false]],
                ["if", [">", ["count", "ast"], 3],
                  ["EVAL", ["nth", "ast", 3], "env"],
                  null],
                ["EVAL", ["nth", "ast", 2], "env"]]],
          ["if", ["=", ["`", "fn*"], "a0"],
            ["malfunc",
              ["fn", ["&", "args"],
                ["let", ["e", ["env-new", "env", ["nth", "ast", 1], "args"]],
                  ["EVAL", ["nth", "ast", 2], "e"]]],
              ["nth", "ast", 2], "env", ["nth", "ast", 1]],
            ["let", ["el", ["eval-ast", "ast", "env"],
                     "f", ["first", "el"],
                     "args", ["rest", "el"]],
              ["if", ["malfunc?", "f"],
                ["EVAL", ["get", "f", ["`", "ast"]],
                         ["env-new", ["get", "f", ["`", "env"]],
                                     ["get", "f", ["`", "params"]],
                                     "args"]],
                ["apply", "f", "args"]]]]]]]]]]]]]],

["def", "PRINT", ["fn", ["exp"],
  ["pr-str", "exp", true]]],


["def", "repl-env", ["env-new"]],

["def", "rep", ["fn", ["strng"],
  ["try",
    ["PRINT", ["EVAL", ["READ", "strng"], "repl-env"]],
    ["catch", "exc",
      ["str", ["`", "Error: "], [".", "exc", ["`", "toString"]]]]]]],

["`", "core.mal: defined using miniMAL"],
["map", ["fn", ["k"], ["env-set", "repl-env",
                                  ["symbol", "k"],
                                  ["get", "core-ns", "k"]]],
        ["keys", "core-ns"]],
["env-set", "repl-env", ["symbol", ["`", "eval"]],
                        ["fn", ["ast"], ["EVAL", "ast", "repl-env"]]],
["env-set", "repl-env", ["symbol", ["`", "*ARGV*"]],
                        ["slice", "*ARGV*", 1]],

["`", "core.mal: defined using mal itself"],
["rep", ["`", "(def! not (fn* (a) (if a false true)))"]],
["rep", ["`", "(def! load-file (fn* (f) (eval (read-string (str \"(do \" (slurp f) \")\")))))"]],

["if", ["not", ["empty?", "*ARGV*"]],
  ["rep", ["str", ["`", "(load-file \""], ["get", "*ARGV*", 0], ["`", "\")"]]],
  ["repl", ["`", "user> "], "rep"]],

null

]
